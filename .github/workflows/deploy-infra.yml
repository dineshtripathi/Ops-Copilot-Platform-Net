name: Deploy Infrastructure

# ================================================================
# Hard-reset layout (Platform/AI subscription split):
#   Job 1 - deploy-platform  →  SubA (rg-opscopilot-platform-*)
#   Job 2 - deploy-ai        →  SubB (rg-opscopilot-ai-*)
#
# Required GitHub secrets:
#   AZURE_TENANT_ID
#   AZURE_CLIENT_ID_PLATFORM   (SubA service principal)
#   AZURE_SUBSCRIPTION_ID_PLATFORM
#   AZURE_CLIENT_ID_AI         (SubB service principal)
#   AZURE_SUBSCRIPTION_ID_AI
#   SQL_ADMIN_PASSWORD_PLATFORM
# ================================================================

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - sandbox
          - prod
      region:
        description: 'Azure region'
        required: false
        default: 'uksouth'
      cleanupEnabled:
        description: 'Delete old TenantA/TenantB RGs before deploying'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

concurrency:
  group: deploy-infra-${{ inputs.environment }}
  cancel-in-progress: false

env:
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  BICEP_ROOT: azure-infra/bicep

jobs:
  # ── Job 1: Cleanup + deploy Platform subscription (SubA) ─────────────────
  deploy-platform:
    name: 'Platform (SubA) — cleanup + deploy'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'prod' && 'prod' || '' }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (Platform SubA)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID_PLATFORM }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_PLATFORM }}

      - name: Resolve Platform SP Object ID
        run: |
          SP_OID=$(az ad sp show --id "${{ secrets.AZURE_CLIENT_ID_PLATFORM }}" --query id -o tsv)
          echo "DEPLOYER_OID=$SP_OID" >> $GITHUB_ENV

      - name: Cleanup old Platform RG (SubA)
        if: ${{ inputs.cleanupEnabled == 'true' }}
        run: |
          chmod +x azure-infra/scripts/cleanup.sh
          azure-infra/scripts/cleanup.sh \
            --env "${{ inputs.environment }}" \
            --subscription-a "${{ secrets.AZURE_SUBSCRIPTION_ID_PLATFORM }}" \
            --target platform

      - name: What-if (Platform)
        run: |
          az deployment sub what-if \
            --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID_PLATFORM }}" \
            --location "${{ inputs.region }}" \
            --template-file "${{ env.BICEP_ROOT }}/main.platform.bicep" \
            --parameters "${{ env.BICEP_ROOT }}/env/${{ inputs.environment }}/platform.parameters.json" \
            --parameters sqlAdminPassword="${{ secrets.SQL_ADMIN_PASSWORD_PLATFORM }}" \
            --parameters deployerObjectId="$DEPLOYER_OID"

      - name: Deploy Platform
        id: deploy_platform
        run: |
          az deployment sub create \
            --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID_PLATFORM }}" \
            --location "${{ inputs.region }}" \
            --template-file "${{ env.BICEP_ROOT }}/main.platform.bicep" \
            --parameters "${{ env.BICEP_ROOT }}/env/${{ inputs.environment }}/platform.parameters.json" \
            --parameters sqlAdminPassword="${{ secrets.SQL_ADMIN_PASSWORD_PLATFORM }}" \
            --parameters deployerObjectId="$DEPLOYER_OID" \
            --name "platform-${{ inputs.environment }}-${{ github.run_id }}" \
            --query "properties.outputs" \
            --output json > /tmp/platform-outputs.json
          cat /tmp/platform-outputs.json

      - name: Store SQL connection string in Key Vault
        run: |
          KV_NAME=$(jq -r '.keyVaultId.value' /tmp/platform-outputs.json | awk -F'/' '{print $NF}')
          CONN_TMPL=$(jq -r '.sqlConnectionStringTemplate.value' /tmp/platform-outputs.json)
          CONN="${CONN_TMPL//<password>/${{ secrets.SQL_ADMIN_PASSWORD_PLATFORM }}}"
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "SqlConnectionString" \
            --value "$CONN"
          echo "SQL connection string stored in KV: $KV_NAME"

      - name: Deployment summary (Platform)
        if: always()
        run: |
          echo "## Platform Deployment — ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Subscription | SubA (Platform) |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          if [[ -f /tmp/platform-outputs.json ]]; then
            echo "| API Host FQDN | $(jq -r '.apiHostFqdn.value // "n/a"' /tmp/platform-outputs.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| MCP Host FQDN | $(jq -r '.mcpHostFqdn.value // "n/a"' /tmp/platform-outputs.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| SQL Server | $(jq -r '.sqlServerFqdn.value // "n/a"' /tmp/platform-outputs.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Qdrant FQDN | $(jq -r '.qdrantFqdn.value // "n/a"' /tmp/platform-outputs.json) |" >> $GITHUB_STEP_SUMMARY
          fi

  # ── Job 2: Cleanup + deploy AI subscription (SubB) ───────────────────────
  deploy-ai:
    name: 'AI (SubB) — cleanup + deploy'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'prod' && 'prod' || '' }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (AI SubB)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID_AI }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_AI }}

      - name: Resolve AI SP Object ID
        run: |
          SP_OID=$(az ad sp show --id "${{ secrets.AZURE_CLIENT_ID_AI }}" --query id -o tsv)
          echo "DEPLOYER_OID=$SP_OID" >> $GITHUB_ENV

      - name: Cleanup old AI RG (SubB)
        if: ${{ inputs.cleanupEnabled == 'true' }}
        run: |
          chmod +x azure-infra/scripts/cleanup.sh
          azure-infra/scripts/cleanup.sh \
            --env "${{ inputs.environment }}" \
            --subscription-b "${{ secrets.AZURE_SUBSCRIPTION_ID_AI }}" \
            --target ai

      - name: What-if (AI)
        run: |
          az deployment sub what-if \
            --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID_AI }}" \
            --location "${{ inputs.region }}" \
            --template-file "${{ env.BICEP_ROOT }}/main.ai.bicep" \
            --parameters "${{ env.BICEP_ROOT }}/env/${{ inputs.environment }}/ai.parameters.json" \
            --parameters deployerObjectId="$DEPLOYER_OID"

      - name: Deploy AI
        id: deploy_ai
        run: |
          az deployment sub create \
            --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID_AI }}" \
            --location "${{ inputs.region }}" \
            --template-file "${{ env.BICEP_ROOT }}/main.ai.bicep" \
            --parameters "${{ env.BICEP_ROOT }}/env/${{ inputs.environment }}/ai.parameters.json" \
            --parameters deployerObjectId="$DEPLOYER_OID" \
            --name "ai-${{ inputs.environment }}-${{ github.run_id }}" \
            --query "properties.outputs" \
            --output json > /tmp/ai-outputs.json
          cat /tmp/ai-outputs.json

      - name: Deploy AOAI models (conditional — deploymentsEnabled=true)
        run: |
          DEPLOY_MODELS=$(jq -r '.deploymentsEnabled.value' /tmp/ai-outputs.json)
          if [[ "$DEPLOY_MODELS" != "true" ]]; then
            echo "deploymentsEnabled=false — skipping AOAI model deployments."
            exit 0
          fi
          AOAI_NAME=$(jq -r '.aoaiAccountName.value' /tmp/ai-outputs.json)
          RG_NAME=$(jq -r '.resourceGroupName.value' /tmp/ai-outputs.json)

          echo "Deploying gpt-4o-mini ..."
          az cognitiveservices account deployment create \
            --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID_AI }}" \
            --resource-group "$RG_NAME" \
            --name "$AOAI_NAME" \
            --deployment-name "gpt-4o-mini" \
            --model-name "gpt-4o-mini" \
            --model-version "2024-07-18" \
            --model-format "OpenAI" \
            --sku-capacity 30 \
            --sku-name "Standard"

          echo "Deploying text-embedding-3-small ..."
          az cognitiveservices account deployment create \
            --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID_AI }}" \
            --resource-group "$RG_NAME" \
            --name "$AOAI_NAME" \
            --deployment-name "text-embedding-3-small" \
            --model-name "text-embedding-3-small" \
            --model-version "1" \
            --model-format "OpenAI" \
            --sku-capacity 120 \
            --sku-name "Standard"

      - name: Store AOAI secrets in Key Vault
        run: |
          KV_NAME=$(jq -r '.keyVaultId.value' /tmp/ai-outputs.json | awk -F'/' '{print $NF}')
          AOAI_NAME=$(jq -r '.aoaiAccountName.value' /tmp/ai-outputs.json)
          RG_NAME=$(jq -r '.resourceGroupName.value' /tmp/ai-outputs.json)
          AOAI_KEY=$(az cognitiveservices account keys list \
            --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID_AI }}" \
            --resource-group "$RG_NAME" \
            --name "$AOAI_NAME" \
            --query key1 --output tsv)
          az keyvault secret set --vault-name "$KV_NAME" --name "AoaiApiKey"   --value "$AOAI_KEY"
          az keyvault secret set --vault-name "$KV_NAME" --name "AoaiEndpoint" --value "$(jq -r '.aoaiEndpoint.value' /tmp/ai-outputs.json)"
          echo "AOAI secrets stored in KV: $KV_NAME"

      - name: Deployment summary (AI)
        if: always()
        run: |
          echo "## AI Deployment — ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Subscription | SubB (AI) |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          if [[ -f /tmp/ai-outputs.json ]]; then
            echo "| AOAI Endpoint | $(jq -r '.aoaiEndpoint.value // "n/a"' /tmp/ai-outputs.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Model Deployments | $(jq -r '.deploymentsEnabled.value // "false"' /tmp/ai-outputs.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| AI Search | $(jq -r '.searchEndpoint.value // "n/a"' /tmp/ai-outputs.json) |" >> $GITHUB_STEP_SUMMARY
          fi
