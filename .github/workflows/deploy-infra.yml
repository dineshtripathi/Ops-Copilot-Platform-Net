name: Deploy OpsCopilot Infrastructure

on:
  workflow_dispatch:
    inputs:
      ENV:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - sandbox
          - prod
      REGION:
        description: 'Azure region (e.g. uksouth)'
        required: true
        default: 'uksouth'
        type: string

# Limit concurrency per environment to prevent parallel conflicting deployments
concurrency:
  group: deploy-infra-${{ inputs.ENV }}
  cancel-in-progress: false

permissions:
  id-token: write   # Required for OIDC
  contents: read

jobs:
  # ─────────────────────────────────────────────────────────
  # WHAT-IF — dry run for both tenants in parallel
  # ─────────────────────────────────────────────────────────
  what-if:
    name: What-If [${{ matrix.tenantLabel }}]
    runs-on: ubuntu-latest
    # Require manual approval for prod (configure "prod" as a GitHub environment with required reviewers)
    environment: ${{ inputs.ENV == 'prod' && 'prod' || '' }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - tenantLabel: TenantA
            clientId: AZURE_CLIENT_ID_TENA
            subscriptionId: AZURE_SUBSCRIPTION_ID_TENA
          - tenantLabel: TenantB
            clientId: AZURE_CLIENT_ID_TENB
            subscriptionId: AZURE_SUBSCRIPTION_ID_TENB

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC) — ${{ matrix.tenantLabel }}
        uses: azure/login@v2
        with:
          client-id: ${{ secrets[matrix.clientId] }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets[matrix.subscriptionId] }}

      - name: Install Bicep CLI
        run: az bicep install

      - name: Bicep Build (lint check)
        run: az bicep build --file azure-infra/bicep/main.bicep

      - name: What-If — ${{ matrix.tenantLabel }}
        run: |
          LABEL_LOWER=$(echo "${{ matrix.tenantLabel }}" | sed 's/TenantA/tenantA/;s/TenantB/tenantB/;s/TenantC/tenantC/')
          PARAM_FILE="azure-infra/bicep/env/${{ inputs.ENV }}/${LABEL_LOWER}.parameters.json"

          echo "Using parameter file: $PARAM_FILE"

          az deployment sub what-if \
            --subscription ${{ secrets[matrix.subscriptionId] }} \
            --location ${{ inputs.REGION }} \
            --template-file azure-infra/bicep/main.bicep \
            --parameters @${PARAM_FILE} \
            --parameters location=${{ inputs.REGION }} environment=${{ inputs.ENV }} \
            --no-prompt

  # ─────────────────────────────────────────────────────────
  # DEPLOY — deploys both tenants in parallel (after what-if)
  # ─────────────────────────────────────────────────────────
  deploy:
    name: Deploy [${{ matrix.tenantLabel }}]
    runs-on: ubuntu-latest
    needs: what-if
    environment: ${{ inputs.ENV == 'prod' && 'prod' || '' }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - tenantLabel: TenantA
            clientId: AZURE_CLIENT_ID_TENA
            subscriptionId: AZURE_SUBSCRIPTION_ID_TENA
          - tenantLabel: TenantB
            clientId: AZURE_CLIENT_ID_TENB
            subscriptionId: AZURE_SUBSCRIPTION_ID_TENB

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC) — ${{ matrix.tenantLabel }}
        uses: azure/login@v2
        with:
          client-id: ${{ secrets[matrix.clientId] }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets[matrix.subscriptionId] }}

      - name: Install Bicep CLI
        run: az bicep install

      - name: Deploy Bicep — ${{ matrix.tenantLabel }}
        id: deploy
        run: |
          LABEL_LOWER=$(echo "${{ matrix.tenantLabel }}" | sed 's/TenantA/tenantA/;s/TenantB/tenantB/;s/TenantC/tenantC/')
          PARAM_FILE="azure-infra/bicep/env/${{ inputs.ENV }}/${LABEL_LOWER}.parameters.json"
          DEPLOYMENT_NAME="opscopilot-${{ matrix.tenantLabel }}-${{ inputs.ENV }}-$(date +%Y%m%d%H%M%S)"

          echo "Deploying with parameter file: $PARAM_FILE"
          echo "Deployment name: $DEPLOYMENT_NAME"

          RESULT=$(az deployment sub create \
            --subscription ${{ secrets[matrix.subscriptionId] }} \
            --location ${{ inputs.REGION }} \
            --name "$DEPLOYMENT_NAME" \
            --template-file azure-infra/bicep/main.bicep \
            --parameters @${PARAM_FILE} \
            --parameters location=${{ inputs.REGION }} environment=${{ inputs.ENV }} \
            --query 'properties.outputs' \
            --output json)

          echo "Deployment outputs: $RESULT"

          FOUNDRY_ENDPOINT=$(echo "$RESULT" | jq -r '.foundryEndpoint.value // ""')
          FOUNDRY_ACCOUNT_NAME=$(echo "$RESULT" | jq -r '.foundryAccountName.value // ""')
          FOUNDRY_ENABLED=$(echo "$RESULT" | jq -r '.foundryEnabled.value // "false"')
          FOUNDRY_PROVISION=$(echo "$RESULT" | jq -r '.foundryProvision.value // "false"' 2>/dev/null || echo "false")
          RG_NAME=$(echo "$RESULT" | jq -r '.rgName.value // ""')
          FOUNDRY_PROJECT_NAME=$(echo "$RESULT" | jq -r '.foundryProjectName.value // ""')

          echo "foundryEndpoint=$FOUNDRY_ENDPOINT"        >> $GITHUB_OUTPUT
          echo "foundryAccountName=$FOUNDRY_ACCOUNT_NAME" >> $GITHUB_OUTPUT
          echo "foundryEnabled=$FOUNDRY_ENABLED"           >> $GITHUB_OUTPUT
          echo "foundryProvision=$FOUNDRY_PROVISION"       >> $GITHUB_OUTPUT
          echo "rgName=$RG_NAME"                           >> $GITHUB_OUTPUT
          echo "foundryProjectName=$FOUNDRY_PROJECT_NAME"  >> $GITHUB_OUTPUT

      # ─────────────────────────────────────────────
      # FOUNDRY CLI STEPS
      # Runs only when foundryProvision=true (account exists)
      # Model deployment + RBAC only when foundryEnabled=true
      # ─────────────────────────────────────────────

      - name: Foundry — Register Cognitive Services provider (idempotent)
        if: steps.deploy.outputs.foundryProvision == 'true'
        run: |
          az provider register --namespace Microsoft.CognitiveServices --wait || true

      - name: Foundry — Create model deployment (gpt-4o-mini)
        if: >
          steps.deploy.outputs.foundryProvision == 'true' &&
          steps.deploy.outputs.foundryEnabled == 'true'
        run: |
          ACCOUNT="${{ steps.deploy.outputs.foundryAccountName }}"
          RG="${{ steps.deploy.outputs.rgName }}"
          DEPLOYMENT_NAME="gpt-4o-mini"
          MODEL_NAME="gpt-4o-mini"
          MODEL_VERSION="2024-07-18"
          SKU_CAPACITY=1    # Minimum capacity — keep token throughput minimal

          echo "Creating model deployment '$DEPLOYMENT_NAME' in account '$ACCOUNT' (rg: $RG)"

          # Idempotent — skip if already exists
          EXISTING=$(az cognitiveservices account deployment show \
            --name "$ACCOUNT" \
            --resource-group "$RG" \
            --deployment-name "$DEPLOYMENT_NAME" \
            --query 'name' --output tsv 2>/dev/null || echo "")

          if [ -n "$EXISTING" ]; then
            echo "Model deployment '$DEPLOYMENT_NAME' already exists — skipping."
          else
            az cognitiveservices account deployment create \
              --name "$ACCOUNT" \
              --resource-group "$RG" \
              --deployment-name "$DEPLOYMENT_NAME" \
              --model-name "$MODEL_NAME" \
              --model-version "$MODEL_VERSION" \
              --model-format "OpenAI" \
              --sku-capacity "$SKU_CAPACITY" \
              --sku-name "Standard"
            echo "Model deployment created."
          fi

      - name: Foundry — Grant app identity Cognitive Services OpenAI User role
        if: >
          steps.deploy.outputs.foundryProvision == 'true' &&
          steps.deploy.outputs.foundryEnabled == 'true'
        run: |
          APP_IDENTITY="${{ secrets.FOUNDRY_APP_IDENTITY_OBJECT_ID }}"

          if [ -z "$APP_IDENTITY" ]; then
            echo "::warning::FOUNDRY_APP_IDENTITY_OBJECT_ID secret not set. Skipping RBAC assignment."
            echo "Set this secret to the Managed Identity or SP Object ID of the OpsCopilot application."
            exit 0
          fi

          ACCOUNT_ID=$(az cognitiveservices account show \
            --name "${{ steps.deploy.outputs.foundryAccountName }}" \
            --resource-group "${{ steps.deploy.outputs.rgName }}" \
            --query 'id' --output tsv)

          echo "Assigning 'Cognitive Services OpenAI User' to $APP_IDENTITY on $ACCOUNT_ID"

          az role assignment create \
            --assignee-object-id "$APP_IDENTITY" \
            --assignee-principal-type "ServicePrincipal" \
            --role "Cognitive Services OpenAI User" \
            --scope "$ACCOUNT_ID" || echo "Role assignment may already exist — continuing."

      - name: Foundry — Log guardrail notice (foundryEnabled=false)
        if: >
          steps.deploy.outputs.foundryProvision == 'true' &&
          steps.deploy.outputs.foundryEnabled != 'true'
        run: |
          echo "=========================================="
          echo "GUARDRAIL ACTIVE: foundryEnabled=false"
          echo "Tenant: ${{ matrix.tenantLabel }}"
          echo "Foundry account is provisioned but:"
          echo "  - No model deployment was created."
          echo "  - No RBAC role was granted to the application identity."
          echo "  - The application CANNOT call Foundry APIs."
          echo "To enable: set foundryEnabled=true in the parameter file and re-run."
          echo "=========================================="

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary — ${{ matrix.tenantLabel }}" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.ENV }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ inputs.REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tenant | ${{ matrix.tenantLabel }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Foundry Endpoint | ${{ steps.deploy.outputs.foundryEndpoint }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Foundry Enabled | ${{ steps.deploy.outputs.foundryEnabled }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ steps.deploy.outputs.rgName }} |" >> $GITHUB_STEP_SUMMARY
