### ================================================================
### OpsCopilot API — REST Client file  (VS Code REST Client extension)
###
### Sections:
###   A. Health
###   B. Triage — happy path
###   C. Triage — runbook-positive path
###   D. Triage — validation cases
###   E. Ingest alert — happy path + validation
###   F. MCP boundary check
###   G. Triage — session-based follow-up
###   H. Session continuity hardening (Dev Slice 4B)
###   I. SafeActions — Execute endpoints (501 guard)
###   J. SafeActions — Dry-Run Execution
###   K. SafeActions — Real HTTP Probe (Dev Slice 9)
###   L. Azure Resource Get (Dev Slice 10)
###   M. Azure Monitor Query (Dev Slice 11)
###   N. Target Allowlist Hardening (Dev Slice 12)
###   O. Tenant-Scoped Execution Policy (Dev Slice 13)
###   P. Execution Replay Guard (Dev Slice 14)
###   Q. Execution Audit Querying (Dev Slice 15)
###   R. Action Detail Audit Enrichment (Dev Slice 16)
###   AA. Evaluation MVP (Dev Slice 25)
###   AB. Connectors MVP — internal-only (Dev Slice 26)
###   AC. Platform Reporting (Dev Slice 27)
###   AD. Tenancy + Governance Config Store (Dev Slice 28)
###
### NOTE on runbook_search:
###   `runbook_search` is NOT a public HTTP endpoint.
###   It is invoked internally by POST /agent/triage via MCP stdio
###   through McpHost (child process). Proof that it ran is visible
###   in the triage response fields: summary.runbookHits > 0 and a
###   non-empty runbookCitations array.
### ================================================================

@baseUrl = http://localhost:5000
@tenantId = tenant-dev-001
@workspaceId = 00000000-0000-0000-0000-000000000001
@timeRange = 120

### NOTE — Fake workspace ID:
###   @workspaceId above is a synthetic GUID that does not map to a
###   real Azure Log Analytics workspace.  KQL queries executed via
###   POST /agent/triage will return Degraded or Failed status because
###   the Azure Monitor SDK cannot resolve this workspace.  This is
###   expected local-dev behaviour; integration with a real workspace
###   requires setting a valid GUID and appropriate AAD credentials.

### ════════════════════════════════════════════════════════════════
### A. Health
### ════════════════════════════════════════════════════════════════

### A1. Health probe  → 200 "healthy"
GET {{baseUrl}}/healthz
Accept: text/plain

### ════════════════════════════════════════════════════════════════
### B. Triage — happy path
### ════════════════════════════════════════════════════════════════

### B1. Full triage (all optional fields populated)
### Expected: 200, status=Completed, citations + runbookCitations present
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "cpu-spike-vm-web-01",
    "title": "CPU usage exceeded 95% for 15 minutes",
    "severity": "High",
    "firedAtUtc": "2025-07-01T14:30:00Z",
    "signalType": "Metric",
    "resourceId": "/subscriptions/sub-xyz/resourceGroups/prod-rg/providers/Microsoft.Compute/virtualMachines/vm-web-01",
    "serviceName": "vm-web-01",
    "environment": "production",
    "correlationId": "corr-abc-001",
    "dimensions": {
      "region": "eastus2",
      "tier": "Standard_D4s_v3"
    }
  },
  "timeRangeMinutes": {{timeRange}},
  "workspaceId": "{{workspaceId}}"
}

### B2. Minimal triage (only required fields)
### Expected: 200, status=Completed
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "alertPayload": {
    "alertSource": "Datadog",
    "fingerprint": "disk-full-db-01"
  }
}

### ════════════════════════════════════════════════════════════════
### C. Triage — runbook-positive path
###    Uses a title that predictably matches embedded runbooks
###    so runbook_search (called internally via MCP) returns hits.
### ════════════════════════════════════════════════════════════════

### C1. Runbook-positive triage
### Expected:
###   - status: "Completed"
###   - summary.runbookHits > 0
###   - runbookCitations: non-empty array (runbookId, title, snippet, score)
###   - citations: also present (KQL results)
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "high-cpu-web-01",
    "title": "High CPU on web-01",
    "severity": "Critical",
    "firedAtUtc": "2025-07-01T15:00:00Z",
    "signalType": "Metric",
    "resourceId": "/subscriptions/sub-xyz/resourceGroups/prod-rg/providers/Microsoft.Compute/virtualMachines/web-01",
    "serviceName": "web-01",
    "environment": "production"
  },
  "timeRangeMinutes": {{timeRange}},
  "workspaceId": "{{workspaceId}}"
}

### ════════════════════════════════════════════════════════════════
### D. Triage — validation cases
### ════════════════════════════════════════════════════════════════

### D1. Missing x-tenant-id header  → 400
POST {{baseUrl}}/agent/triage
Content-Type: application/json

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "cpu-spike-vm-web-01"
  }
}

### D2. Missing alertPayload  → 400
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "timeRangeMinutes": 60
}

### D3. Blank alertSource  → 400
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "alertPayload": {
    "alertSource": "  ",
    "fingerprint": "cpu-spike-vm-web-01"
  }
}

### D4. timeRangeMinutes out of range (max 1440)  → 400
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "cpu-spike-vm-web-01"
  },
  "timeRangeMinutes": 9999
}

### D5. Invalid workspaceId (not a GUID)  → 400
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "cpu-spike-vm-web-01"
  },
  "workspaceId": "not-a-guid"
}

### ════════════════════════════════════════════════════════════════
### E. Ingest alert
###
### NOTE — Pending status:
###   Ingested alerts are created with Status = Pending and remain
###   in that state. Transitioning Pending → Completed requires an
###   orchestration / triage pipeline that is planned for a future
###   dev slice. Until then, querying GET /agent-runs will show
###   ingested records stuck at Pending — this is expected.
### ════════════════════════════════════════════════════════════════

### E1. Ingest alert — happy path
POST {{baseUrl}}/ingest/alert
Content-Type: application/json
x-tenant-id: {{tenantId}}
x-correlation-id: req-abc-001

{
  "payload": "{\"alertId\":\"alert-001\",\"severity\":\"High\",\"resourceId\":\"/subscriptions/sub-xyz/resourceGroups/prod-rg/providers/Microsoft.Compute/virtualMachines/vm-web-01\",\"description\":\"CPU usage exceeded 95% for 15 minutes\"}"
}

### E2. Ingest alert — missing x-tenant-id  → 400
POST {{baseUrl}}/ingest/alert
Content-Type: application/json

{
  "payload": "{\"alertId\":\"alert-001\"}"
}

### ════════════════════════════════════════════════════════════════
### F. MCP boundary check
###    Proves MCP tools (kql_query, runbook_search) are NOT
###    reachable over HTTP. They run only via MCP stdio transport
###    inside McpHost. Any attempt to call them via HTTP → 404.
### ════════════════════════════════════════════════════════════════

### F1. POST /mcp/tools/kql_query → 404 (no such HTTP route)
POST {{baseUrl}}/mcp/tools/kql_query
Content-Type: application/json

{}

### F2. POST /mcp/tools/runbook_search → 404 (no such HTTP route)
POST {{baseUrl}}/mcp/tools/runbook_search
Content-Type: application/json

{}

### ════════════════════════════════════════════════════════════════
### G. Triage — session-based follow-up (Dev Slice 4A)
###    sessionId is an optional field. When omitted, a new session
###    is created. When provided, the existing session is resumed.
###    Response includes sessionId, isNewSession, sessionExpiresAtUtc.
### ════════════════════════════════════════════════════════════════

### G1. Triage — new session (no sessionId)
### Expected: 200, isNewSession=true, sessionId + sessionExpiresAtUtc present
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "session-test-new-01",
    "title": "Session test — new session",
    "severity": "Medium"
  },
  "timeRangeMinutes": {{timeRange}},
  "workspaceId": "{{workspaceId}}"
}

### ──────────────────────────────────────────────────────────────
### HOW-TO: After running G1, copy the "sessionId" value from the
### response JSON and paste it into @sessionId below. Then run G2.
### ──────────────────────────────────────────────────────────────

### G2. Triage — resume existing session
### Usage: copy the sessionId from G1's response and paste below.
### Expected: 200, isNewSession=false, same sessionId returned
@sessionId = 00000000-0000-0000-0000-000000000000
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "session-test-resume-01",
    "title": "Session test — resume session",
    "severity": "Medium"
  },
  "timeRangeMinutes": {{timeRange}},
  "workspaceId": "{{workspaceId}}",
  "sessionId": "{{sessionId}}"
}

### G3. Triage — invalid sessionId (non-existent)
### Expected: 200 (new session created with warning log), isNewSession=true
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "session-test-invalid-01",
    "title": "Session test — invalid sessionId"
  },
  "sessionId": "deadbeef-dead-beef-dead-beefdeadbeef"
}

### ════════════════════════════════════════════════════════════════
### H. Session continuity hardening (Dev Slice 4B)
###    Tests tenant-safety, expired-session fallback, and
###    session-context carry-over (usedSessionContext flag).
### ════════════════════════════════════════════════════════════════

### H1. Tenant mismatch → 403 Forbidden
### Usage: run G1 with x-tenant-id: tenant-dev-001, copy the sessionId
###        from the response, paste into @sessionId above, then run H1.
### Expected: 403, Problem Details with title "Session tenant mismatch"
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: tenant-verify-4b

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "tenant-mismatch-01",
    "title": "Session test — tenant mismatch (4B)"
  },
  "sessionId": "{{sessionId}}"
}

### H2. Expired session → new session fallback
### Usage: wait for the session TTL to expire (default 30 min), or
###        temporarily lower Governance:Defaults:SessionTtlMinutes
###        in appsettings, then provide the expired sessionId.
### Expected: 200, isNewSession=true, new sessionId returned
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "expired-session-01",
    "title": "Session test — expired session fallback (4B)"
  },
  "sessionId": "{{sessionId}}"
}

### H3. Session resume — usedSessionContext flag
### Usage: run G1 to create a session, copy the sessionId into
###        @sessionId, then run H3.
### Expected: 200, isNewSession=false, usedSessionContext=true,
###           response includes data from prior run context
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantId}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "session-context-01",
    "title": "Session test — verify usedSessionContext (4B)"
  },
  "timeRangeMinutes": {{timeRange}},
  "workspaceId": "{{workspaceId}}",
  "sessionId": "{{sessionId}}"
}

###############################################################################
# I · SafeActions — Execute endpoints (501 guard)
#     SafeActions:EnableExecution = false (default) → 501 Not Implemented
#     Set the flag to true in appsettings to enable execution.
###############################################################################

### I1 · Execute a safe-action (expect 501 while guard is off)
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-7

### I2 · Execute rollback for a safe-action (expect 501 while guard is off)
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/rollback/execute
Content-Type: application/json
x-tenant-id: tenant-verify-7

###############################################################################
# J · SafeActions — Dry-Run Execution (requires EnableExecution = true)
#     Requires  SafeActions:EnableExecution = true  in appsettings.
#     DryRunActionExecutor returns deterministic JSON — no external side effects.
#     Payload containing "simulateFailure": true triggers a simulated failure.
###############################################################################

### J1 · Dry-run execute — normal payload (expect 200 with dry-run outcome)
# @name dryRunExecute
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-8

### J2 · Dry-run execute — simulateFailure payload (expect 200, status=Failed)
# @name dryRunSimulateFailure
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000002/execute
Content-Type: application/json
x-tenant-id: tenant-verify-8

### J3 · Dry-run rollback execute (expect 200 with dry-run-rollback outcome)
# @name dryRunRollbackExecute
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/rollback/execute
Content-Type: application/json
x-tenant-id: tenant-verify-8

###############################################################################
# K · SafeActions — Real HTTP Probe (Dev Slice 9)
#
#     TWO-FLAG SAFETY MODEL:
#       1. SafeActions:EnableExecution = true   (endpoint guard — 501 otherwise)
#       2. SafeActions:EnableRealHttpProbe = true (routes http_probe to real executor)
#
#     Both flags default to FALSE. When EnableRealHttpProbe is false, http_probe
#     actions fall back to the dry-run executor. Non-http_probe action types
#     ALWAYS use the dry-run executor regardless of the probe flag.
#
#     Additional settings:
#       SafeActions:HttpProbeTimeoutMs       (default 5000)
#       SafeActions:HttpProbeMaxResponseBytes (default 1024)
#
#     SSRF protection: only HTTPS URLs are allowed; localhost, *.internal,
#     private IP ranges, IMDS, and loopback addresses are blocked.
###############################################################################

### K1 · http_probe execute — real probe (EnableExecution=true, EnableRealHttpProbe=true)
###      Requires an Approved ActionRecord with actionType="http_probe" and
###      payload: {"url":"https://example.com","method":"GET"}
###      Expected: 200, outcomeJson contains mode="real_http_probe", statusCode, responseSnippet
# @name httpProbeRealExecute
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000003/execute
Content-Type: application/json
x-tenant-id: tenant-verify-9

### K2 · http_probe execute — dry-run fallback (EnableExecution=true, EnableRealHttpProbe=false)
###      Same as K1 but with EnableRealHttpProbe=false.
###      Expected: 200, outcomeJson contains mode="dry-run"
# @name httpProbeDryRunFallback
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000003/execute
Content-Type: application/json
x-tenant-id: tenant-verify-9

### K3 · http_probe rollback — not supported
###      Real probe executor does not support rollback.
###      Expected: 200, outcomeJson contains "rollback is not supported for http_probe"
# @name httpProbeRollbackNotSupported
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000003/rollback/execute
Content-Type: application/json
x-tenant-id: tenant-verify-9

### K4 · non-probe action — always dry-run even when probe flag is on
###      Uses a record with actionType="restart_pod". EnableRealHttpProbe=true.
###      Expected: 200, outcomeJson contains mode="dry-run"
# @name nonProbeAlwaysDryRun
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-9

# ═══════════════════════════════════════════════════════════════
# L · Azure Resource Get (Slice 10) — THREE-FLAG SAFETY MODEL
# ═══════════════════════════════════════════════════════════════
#
# Requires:
#   SafeActions:EnableExecution          = true   (endpoint guard)
#   SafeActions:EnableAzureReadExecutions = true   (azure gate)
#
# Uses DefaultAzureCredential — authenticate via:
#   az login, AZURE_TENANT_ID env var, or Managed Identity
#
# Payload: { "resourceId": "/subscriptions/.../providers/..." }
# Returns metadata ONLY (name, type, location, state, etag, tagsCount)
# NO data-plane access, NO resource modification, GET-only

### L1 · azure_resource_get execute — real SDK call (requires both flags)
###      Pre: Create & approve an ActionRecord with actionType="azure_resource_get"
###           and payload {"resourceId":"/subscriptions/<sub>/resourceGroups/<rg>/providers/Microsoft.Compute/virtualMachines/<vm>"}
###      Expected: 200, outcomeJson contains mode="azure_resource_get"
# @name azureGetExecuteReal
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-10

### L2 · azure_resource_get execute — dry-run fallback (EnableAzureReadExecutions=false)
###      Expected: 200, outcomeJson contains mode="dry-run"
# @name azureGetDryRunFallback
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-10

### L3 · azure_resource_get rollback — not supported
###      Expected: 200, outcomeJson contains "rollback is not supported for azure_resource_get"
# @name azureGetRollbackNotSupported
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/rollback
Content-Type: application/json
x-tenant-id: tenant-verify-10

### L4 · azure_resource_get with invalid resourceId — deterministic error
###      Pre: payload {"resourceId":"not-a-valid-id"}
###      Expected: 200, outcomeJson contains errorCode="invalid_resource_id"
# @name azureGetInvalidResourceId
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-10

# ═══════════════════════════════════════════════════════════════
# M · Azure Monitor Query (Slice 11) — FOUR-FLAG SAFETY MODEL
# ═══════════════════════════════════════════════════════════════
#
# Requires:
#   SafeActions:EnableExecution                = true  (endpoint guard)
#   SafeActions:EnableAzureMonitorReadExecutions = true (monitor gate)
#
# Uses DefaultAzureCredential — authenticate via:
#   az login, AZURE_TENANT_ID env var, or Managed Identity
#
# Payload:
#   {
#     "workspaceId": "<GUID>",      — Log Analytics workspace ID
#     "query": "<KQL string>",      — read-only KQL query
#     "timespanMinutes": 60          — optional, default 60, clamped [1..1440]
#   }
#
# Blocked query patterns (case-insensitive): .create, .alter, .drop,
#   .ingest, .set, .append, .delete, .execute
#
# Returns: { mode, success, workspaceId, rowCount, columnCount, rows }
# NO writes, NO data modification, read-only KQL queries ONLY

### M1 · azure_monitor_query execute — real SDK call (requires both flags)
###      Pre: Create & approve an ActionRecord with actionType="azure_monitor_query"
###           and payload {"workspaceId":"<workspace-guid>","query":"Heartbeat | take 5"}
###      Expected: 200, outcomeJson contains mode="azure_monitor_query"
# @name azureMonitorQueryExecuteReal
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-11

### M2 · azure_monitor_query execute — dry-run fallback (EnableAzureMonitorReadExecutions=false)
###      Expected: 200, outcomeJson contains mode="dry-run"
# @name azureMonitorQueryDryRunFallback
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-11

### M3 · azure_monitor_query rollback — not supported
###      Expected: 200, outcomeJson contains reason="not_supported"
# @name azureMonitorQueryRollbackNotSupported
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/rollback
Content-Type: application/json
x-tenant-id: tenant-verify-11

### M4 · azure_monitor_query with blocked pattern — deterministic error
###      Pre: payload {"workspaceId":"<guid>","query":".drop table foo"}
###      Expected: 200, outcomeJson contains reason="blocked_query_pattern"
# @name azureMonitorQueryBlockedPattern
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-11

### M5 · azure_monitor_query with invalid workspaceId — deterministic error
###      Pre: payload {"workspaceId":"not-a-guid","query":"Heartbeat"}
###      Expected: 200, outcomeJson contains reason="invalid_workspace_id"
# @name azureMonitorQueryInvalidWorkspace
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-11

###############################################################################
# N · Slice 12 – Target Allowlist Hardening
#     Config: SafeActions:AllowedAzureSubscriptionIds
#             SafeActions:AllowedLogAnalyticsWorkspaceIds
#     Empty list = no restriction (backward compatible).
###############################################################################

### N1 · azure_resource_get with allowlisted subscription — succeeds
###      Pre: Add subscription to AllowedAzureSubscriptionIds config
###      Expected: 200, outcomeJson Success=true (if ARM resource exists)
# @name azureGetAllowlistedSubscription
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-12

### N2 · azure_resource_get with non-allowlisted subscription — rejected
###      Pre: Subscription NOT in AllowedAzureSubscriptionIds
###      Expected: 200, outcomeJson contains reason="target_not_allowlisted"
# @name azureGetNonAllowlistedSubscription
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-12

### N3 · azure_monitor_query with allowlisted workspace — succeeds
###      Pre: WorkspaceId in AllowedLogAnalyticsWorkspaceIds config
###      Expected: 200, outcomeJson Success=true (if workspace reachable)
# @name azureMonitorQueryAllowlistedWorkspace
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-12

### N4 · azure_monitor_query with non-allowlisted workspace — rejected
###      Pre: WorkspaceId NOT in AllowedLogAnalyticsWorkspaceIds
###      Expected: 200, outcomeJson contains reason="target_not_allowlisted"
# @name azureMonitorQueryNonAllowlistedWorkspace
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-12

###############################################################################
# O · Slice 13 – Tenant-Scoped Execution Policy (STRICT)
#
#     Config: SafeActions:AllowedExecutionTenants:<actionType>:[0..N]
#     Maps each action type to an explicit list of authorized tenant IDs.
#
#     STRICT DENY-by-default:
#       - Action type key missing from config       → DENY
#       - Action type key present but tenant list empty → DENY
#       - Tenant ID not in the list                 → DENY
#
#     Error: 400, reasonCode = "tenant_not_authorized_for_action"
#
#     Precedence: EnableExecution=false (501) > tenant policy deny (400)
#                 > executor routing
#
#     Requires: SafeActions:EnableExecution = true  AND  an Approved record.
###############################################################################

### O1 · Execute with authorized tenant — succeeds
###      Pre: AllowedExecutionTenants:restart_pod:0 = tenant-verify-13
###           Record in Approved status, actionType = restart_pod
###      Expected: 200
# @name executeAuthorizedTenant
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-13

### O2 · Execute with unauthorized tenant — denied
###      Pre: AllowedExecutionTenants:restart_pod does NOT include tenant-blocked
###           Record in Approved status, actionType = restart_pod
###      Expected: 400, body.reasonCode = "tenant_not_authorized_for_action"
# @name executeUnauthorizedTenant
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-blocked

### O3 · Execute with missing action type config — denied (strict)
###      Pre: No AllowedExecutionTenants entry for action type "scale_up"
###           Record in Approved status, actionType = scale_up
###      Expected: 400, body.reasonCode = "tenant_not_authorized_for_action"
# @name executeMissingActionTypeConfig
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-13

### O4 · Rollback-execute with unauthorized tenant — denied
###      Pre: AllowedExecutionTenants:restart_pod does NOT include tenant-blocked
###           Record in RollbackApproved status, actionType = restart_pod
###      Expected: 400, body.reasonCode = "tenant_not_authorized_for_action"
# @name rollbackExecuteUnauthorizedTenant
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/rollback/execute
Content-Type: application/json
x-tenant-id: tenant-blocked

### O5 · Execute returns 501 even when tenant would be denied — precedence
###      Pre: SafeActions:EnableExecution = false (default)
###      Expected: 501 (guard wins before tenant policy is evaluated)
# @name executePrecedenceGuardWins
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-blocked

## ═══════════════════════════════════════════════════════════════════
## P · Execution Replay Guard  (Slice 14 — tenant-verify-14)
## ═══════════════════════════════════════════════════════════════════

### P1 · Execute on already-completed record → 409 Conflict
###      Pre: Record has been approved, executed, and completed
###      Expected: 409 — replay blocked because status is Completed
# @name executeReplayCompleted
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-14

### P2 · Execute on already-failed record → 409 Conflict
###      Pre: Record has been approved, executed, and failed
###      Expected: 409 — replay blocked because status is Failed
# @name executeReplayFailed
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-14

### P3 · Execute on currently-executing record → 409 Conflict
###      Pre: Record is already in Executing status
###      Expected: 409 — replay blocked because status is Executing
# @name executeReplayExecuting
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/execute
Content-Type: application/json
x-tenant-id: tenant-verify-14

### P4 · Rollback-execute on already-rolled-back record → 409 Conflict
###      Pre: Record rollback has been approved and completed
###      Expected: 409 — replay blocked because rollback status is RolledBack
# @name rollbackReplayRolledBack
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/rollback/execute
Content-Type: application/json
x-tenant-id: tenant-verify-14

### P5 · Rollback-execute on rollback-failed record → 409 Conflict
###      Pre: Record rollback has been approved and failed
###      Expected: 409 — replay blocked because rollback status is RollbackFailed
# @name rollbackReplayRollbackFailed
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/rollback/execute
Content-Type: application/json
x-tenant-id: tenant-verify-14

## ═══════════════════════════════════════════════════════════════════
## Q · Execution Audit Querying  (Slice 15 — tenant-verify-15)
## ═══════════════════════════════════════════════════════════════════

### Q1 · List with no filters → 200 OK (default query)
###      Expected: 200 with array, audit fields present on each item
# @name listDefaultQuery
GET {{baseUrl}}/safe-actions
x-tenant-id: tenant-verify-15

### Q2 · Filter by status → 200 OK
###      Expected: Only records with status=Proposed returned
# @name listFilterByStatus
GET {{baseUrl}}/safe-actions?status=Proposed
x-tenant-id: tenant-verify-15

### Q3 · Filter by rollbackStatus → 200 OK
###      Expected: Only records with rollbackStatus=Available
# @name listFilterByRollbackStatus
GET {{baseUrl}}/safe-actions?rollbackStatus=Available
x-tenant-id: tenant-verify-15

### Q4 · Filter by actionType → 200 OK
###      Expected: Only records with matching actionType
# @name listFilterByActionType
GET {{baseUrl}}/safe-actions?actionType=restart_pod
x-tenant-id: tenant-verify-15

### Q5 · Filter by hasExecutionLogs → 200 OK
###      Expected: Only records that have execution logs
# @name listFilterByHasExecutionLogs
GET {{baseUrl}}/safe-actions?hasExecutionLogs=true
x-tenant-id: tenant-verify-15

### Q6 · Filter by date range → 200 OK
###      Expected: Only records within the date range
# @name listFilterByDateRange
GET {{baseUrl}}/safe-actions?fromUtc=2025-01-01T00:00:00Z&toUtc=2025-12-31T23:59:59Z
x-tenant-id: tenant-verify-15

### Q7 · Combined filters → 200 OK
###      Expected: Records matching all filter criteria
# @name listCombinedFilters
GET {{baseUrl}}/safe-actions?status=Completed&actionType=restart_pod&limit=10&fromUtc=2025-01-01T00:00:00Z
x-tenant-id: tenant-verify-15

### Q8 · Custom limit → 200 OK
###      Expected: At most 5 records returned
# @name listCustomLimit
GET {{baseUrl}}/safe-actions?limit=5
x-tenant-id: tenant-verify-15

### Q9 · Invalid status value → 400 Bad Request
###      Expected: 400 with "Invalid status value"
# @name listInvalidStatus
GET {{baseUrl}}/safe-actions?status=NotARealStatus
x-tenant-id: tenant-verify-15

### Q10 · Invalid rollbackStatus value → 400 Bad Request
###       Expected: 400 with "Invalid rollbackStatus value"
# @name listInvalidRollbackStatus
GET {{baseUrl}}/safe-actions?rollbackStatus=BOGUS
x-tenant-id: tenant-verify-15

### Q11 · Invalid fromUtc date → 400 Bad Request
###       Expected: 400 with "Invalid fromUtc value"
# @name listInvalidFromUtc
GET {{baseUrl}}/safe-actions?fromUtc=not-a-date
x-tenant-id: tenant-verify-15

### Q12 · fromUtc after toUtc → 400 Bad Request
###       Expected: 400 with "fromUtc must not be after toUtc"
# @name listFromAfterTo
GET {{baseUrl}}/safe-actions?fromUtc=2025-12-31T00:00:00Z&toUtc=2025-01-01T00:00:00Z
x-tenant-id: tenant-verify-15

### Q13 · Missing tenant header → 400 Bad Request
###       Expected: 400 — x-tenant-id is required
# @name listMissingTenant
GET {{baseUrl}}/safe-actions

### Q14 · RunId-only path (existing behavior) → 200 OK
###       Expected: 200 with records for the given runId, audit-enriched
# @name listByRunId
GET {{baseUrl}}/safe-actions?runId=00000000-0000-0000-0000-000000000001
x-tenant-id: tenant-verify-15

## ═══════════════════════════════════════════════════════════════════
## R · Action Detail Audit Enrichment  (Slice 16 — tenant-verify-16)
## ═══════════════════════════════════════════════════════════════════

### R1 · GET by ID returns approval history → 200 OK
###      Expected: 200 with approvals[] populated
# @name getDetailApprovals
GET {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001
x-tenant-id: tenant-verify-16

### R2 · GET by ID returns execution log history → 200 OK
###      Expected: 200 with executionLogs[] populated
# @name getDetailExecutionLogs
GET {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001
x-tenant-id: tenant-verify-16

### R3 · GET by ID with no audit data → 200 OK
###      Expected: 200 with approvals=[], executionLogs=[], zero audit counts
# @name getDetailEmptyAudit
GET {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000002
x-tenant-id: tenant-verify-16

### R4 · GET by non-existent ID → 404 Not Found
###      Expected: 404
# @name getDetailNotFound
GET {{baseUrl}}/safe-actions/00000000-0000-0000-0000-ffffffffffff
x-tenant-id: tenant-verify-16

### R5 · GET by ID verifies payload redaction → 200 OK
###      Expected: executionLogs[].requestPayloadJson and responsePayloadJson
###               have sensitive keys (token, password, secret, key, connectionString)
###               replaced with "[REDACTED]"
# @name getDetailRedaction
GET {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001
x-tenant-id: tenant-verify-16

### R6 · GET by ID includes audit summary fields → 200 OK
###      Expected: executionLogCount, lastExecutionSuccess, approvalCount,
###               lastApprovalDecision present
# @name getDetailAuditSummary
GET {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001
x-tenant-id: tenant-verify-16


## ═══════════════════════════════════════════════════════════════
## S · Auth/Claims Identity Hardening  (Slice 17 — tenant-verify-17)
## ═══════════════════════════════════════════════════════════════

### S1 · Approve action with x-actor-id header fallback → 200 OK
###      Expected: 200, approvedBy = the value from x-actor-id header
###      Requires: a Proposed action record exists at the given ID
# @name approveWithHeader
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000001/approve
x-tenant-id: tenant-verify-17
x-actor-id: dev-operator-17
Content-Type: application/json

{
  "reason": "Approved via header fallback in Slice 17"
}

### S2 · Approve action without header (anonymous fallback) → 200 OK
###      Expected: 200 (in dev with AllowAnonymousActorFallback=true),
###               approvedBy = "unknown"
###      Requires: a Proposed action record exists at the given ID
# @name approveAnonymousFallback
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000002/approve
x-tenant-id: tenant-verify-17
Content-Type: application/json

{
  "reason": "Approved without actor header — anonymous fallback"
}

### S3 · Reject action with x-actor-id header fallback → 200 OK
###      Expected: 200, rejectedBy = the value from x-actor-id header
###      Requires: a Proposed action record exists at the given ID
# @name rejectWithHeader
POST {{baseUrl}}/safe-actions/00000000-0000-0000-0000-000000000003/reject
x-tenant-id: tenant-verify-17
x-actor-id: dev-operator-17
Content-Type: application/json

{
  "reason": "Rejected via header fallback in Slice 17"
}

###########################################################################
# Section T – S18 – Observability Smoke
# Purpose : Verify that observed endpoints still return expected statuses.
#           Counters are validated in unit tests; this section confirms
#           the DI-registered telemetry does not break runtime behaviour.
###########################################################################

@tenantT = tenant-verify-18

### T1 · Propose action (baseline for later queries) → 201 Created
# @name proposeForObservability
POST {{baseUrl}}/safe-actions
x-tenant-id: {{tenantT}}
Content-Type: application/json

{
  "agentRunId": "{{$guid}}",
  "actionType": "restart_pod",
  "payloadJson": "{\"target\":\"pod-obs-1\"}",
  "rollbackPayloadJson": "{\"undo\":\"stop_pod\"}"
}

### T2 · Get proposed action detail → 200 OK  (records query.requests counter)
# @name getDetailObservability
GET {{baseUrl}}/safe-actions/{{proposeForObservability.response.body.$.actionRecordId}}
x-tenant-id: {{tenantT}}

### T3 · List actions for tenant → 200 OK  (records query.requests counter)
# @name listActionsObservability
GET {{baseUrl}}/safe-actions?tenantId={{tenantT}}&pageSize=5&pageNumber=1
x-tenant-id: {{tenantT}}

### T4 · List with invalid date range → 400 Bad Request (records query.validation_failures)
# @name listBadRange
GET {{baseUrl}}/safe-actions?tenantId={{tenantT}}&fromUtc=2099-01-01T00:00:00Z&toUtc=2000-01-01T00:00:00Z&pageSize=5&pageNumber=1
x-tenant-id: {{tenantT}}

### T5 · Execute without approval → 409 or replay conflict (records replay_conflict)
# @name executeBeforeApproval
POST {{baseUrl}}/safe-actions/{{proposeForObservability.response.body.$.actionRecordId}}/execute
x-tenant-id: {{tenantT}}

###########################################################################
# Section U — S19 — Execution Throttling Smoke
# Purpose : Verify that in-process throttle guard returns 429 when limits
#           are exceeded, and passes through when disabled or under limit.
#           Requires appsettings EnableExecutionThrottling = true,
#           ExecutionThrottleWindowSeconds = 60,
#           ExecutionThrottleMaxAttemptsPerWindow = 5.
###########################################################################

@tenantU = tenant-verify-19

### U1 · Propose action for throttle testing → 201 Created
# @name proposeForThrottle
POST {{baseUrl}}/safe-actions
x-tenant-id: {{tenantU}}
Content-Type: application/json

{
  "agentRunId": "{{$guid}}",
  "actionType": "restart_pod",
  "payloadJson": "{\"target\":\"pod-throttle-1\"}",
  "rollbackPayloadJson": "{\"undo\":\"stop_pod\"}"
}

### U2 · Approve the proposed action → 200 OK
# @name approveForThrottle
POST {{baseUrl}}/safe-actions/{{proposeForThrottle.response.body.$.actionRecordId}}/approve
x-tenant-id: {{tenantU}}
Content-Type: application/json

{
  "reason": "Approved for throttle test"
}

### U3 · Execute (attempt 1 / within window) → 200 OK
###      With throttling enabled and maxAttempts=5. First call should succeed.
# @name executeThrottlePass
POST {{baseUrl}}/safe-actions/{{proposeForThrottle.response.body.$.actionRecordId}}/execute
x-tenant-id: {{tenantU}}

### U4 · Propose + Approve another action for repeated attempts
# @name proposeForThrottle2
POST {{baseUrl}}/safe-actions
x-tenant-id: {{tenantU}}
Content-Type: application/json

{
  "agentRunId": "{{$guid}}",
  "actionType": "restart_pod",
  "payloadJson": "{\"target\":\"pod-throttle-2\"}",
  "rollbackPayloadJson": "{\"undo\":\"stop_pod\"}"
}

### U5 · Approve second action
# @name approveForThrottle2
POST {{baseUrl}}/safe-actions/{{proposeForThrottle2.response.body.$.actionRecordId}}/approve
x-tenant-id: {{tenantU}}
Content-Type: application/json

{
  "reason": "Approved for throttle overflow test"
}

### U6 · Execute second action (continues window counter) → eventually 429
###      Run U3-U6 rapidly to exceed maxAttempts=5.
###      Expected once limit exceeded: 429 with { reasonCode, message, retryAfterSeconds }
# @name executeThrottleDeny
POST {{baseUrl}}/safe-actions/{{proposeForThrottle2.response.body.$.actionRecordId}}/execute
x-tenant-id: {{tenantU}}

### U7 · Rollback-execute throttle test → 429 when over limit
###      Same tenant+actionType key counts toward the same window.
# @name rollbackExecuteThrottleDeny
POST {{baseUrl}}/safe-actions/{{proposeForThrottle2.response.body.$.actionRecordId}}/rollback/execute
x-tenant-id: {{tenantU}}

###########################################################################
# V · Slice 20 — Retry-After Header on 429 Responses
#     Verifies that throttled (429) responses include a Retry-After HTTP
#     header whose value matches the retryAfterSeconds JSON body field.
#     Precondition: Set SafeActions:Throttle:MaxAttempts to 1 and
#     SafeActions:Throttle:WindowSeconds to 60 so the second execute is
#     guaranteed to be denied (429).
###########################################################################

@tenantV = tenant-verify-20

### V1 · Propose + Approve an action for retry-after verification
# @name proposeForRetryAfter
POST {{baseUrl}}/safe-actions
x-tenant-id: {{tenantV}}
Content-Type: application/json

{
  "agentRunId": "{{$guid}}",
  "actionType": "restart_pod",
  "payloadJson": "{\"target\":\"pod-retry-after\"}",
  "rollbackPayloadJson": "{\"undo\":\"stop_pod\"}"
}

### V2 · Approve the action
# @name approveForRetryAfter
POST {{baseUrl}}/safe-actions/{{proposeForRetryAfter.response.body.$.actionRecordId}}/approve
x-tenant-id: {{tenantV}}
Content-Type: application/json

{
  "reason": "Approved for Retry-After header test"
}

### V3 · Execute (burns the only attempt in the window) → 200 OK
# @name executeRetryAfterPass
POST {{baseUrl}}/safe-actions/{{proposeForRetryAfter.response.body.$.actionRecordId}}/execute
x-tenant-id: {{tenantV}}

### V4 · Second execute → 429 Too Many Requests
###      Expected response headers include:
###        Retry-After: <seconds>   (matches body retryAfterSeconds)
###      Expected JSON body:
###        { "reasonCode": "throttled", "message": "...", "retryAfterSeconds": <seconds> }
# @name executeRetryAfterDeny
POST {{baseUrl}}/safe-actions/{{proposeForRetryAfter.response.body.$.actionRecordId}}/execute
x-tenant-id: {{tenantV}}

###########################################################################
# W · Slice 21 — ActionType Catalog + Allowlist + Risk Tiering
###########################################################################

@tenantW = tenant-verify-21

### W1 · Propose a known, enabled action type → 200 OK with riskTier
# @name proposeAllowedType
POST {{baseUrl}}/safe-actions
x-tenant-id: {{tenantW}}
Content-Type: application/json

{
  "agentRunId": "{{$guid}}",
  "actionType": "restart_pod",
  "payloadJson": "{\"target\":\"pod-catalog-w1\"}",
  "rollbackPayloadJson": "{\"undo\":\"stop_pod\"}"
}

### W2 · Propose an unknown action type → 400 Bad Request, action_type_not_allowed
# @name proposeDeniedType
POST {{baseUrl}}/safe-actions
x-tenant-id: {{tenantW}}
Content-Type: application/json

{
  "agentRunId": "{{$guid}}",
  "actionType": "delete_universe",
  "payloadJson": "{\"target\":\"everything\"}"
}

### W3 · GET detail by id → verify riskTier in response
# @name getDetailWithRiskTier
GET {{baseUrl}}/safe-actions/{{proposeAllowedType.response.body.$.actionRecordId}}
x-tenant-id: {{tenantW}}

### W4 · GET list → verify riskTier on each item
# @name listWithRiskTier
GET {{baseUrl}}/safe-actions
x-tenant-id: {{tenantW}}

###########################################################################
# X · Slice 22 — AgentRuns Redis Session Store (Durable Session Hardening)
#     Verifies that the session contract is preserved regardless of the
#     backing store (InMemory default or Redis when configured).
#     These requests exercise the same session lifecycle as Section G but
#     under a dedicated tenant to prove session durability behaviour.
###########################################################################

@tenantX = tenant-verify-22

### X1 · New triage — omit sessionId → new session created → 200 OK
###      Expected: isNewSession=true, sessionId present, sessionExpiresAtUtc present
# @name triageNewSessionX
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantX}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "redis-session-new-01",
    "title": "Slice 22 — new session test",
    "severity": "Medium"
  },
  "timeRangeMinutes": 120,
  "workspaceId": "{{workspaceId}}"
}

### X2 · Resume triage — reuse sessionId from X1 → same session → 200 OK
###      Expected: isNewSession=false, same sessionId returned,
###      sessionExpiresAtUtc extended (sliding TTL)
# @name triageResumeSessionX
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantX}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "redis-session-resume-01",
    "title": "Slice 22 — resume session test",
    "severity": "Medium"
  },
  "timeRangeMinutes": 120,
  "workspaceId": "{{workspaceId}}",
  "sessionId": "{{triageNewSessionX.response.body.$.sessionId}}"
}

### X3 · Cross-tenant isolation — use X1's sessionId with different tenant → new session
###      Expected: 200 OK, isNewSession=true (session belongs to tenantX, not tenantX-other)
# @name triageCrossTenantX
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantX}}-other

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "redis-session-cross-tenant-01",
    "title": "Slice 22 — cross-tenant isolation test"
  },
  "sessionId": "{{triageNewSessionX.response.body.$.sessionId}}"
}

### X4 · Non-existent sessionId → creates new session gracefully → 200 OK
###      Expected: isNewSession=true, new sessionId (not the bogus one)
# @name triageBogusSessionX
POST {{baseUrl}}/agent/triage
Content-Type: application/json
x-tenant-id: {{tenantX}}

{
  "alertPayload": {
    "alertSource": "Azure Monitor",
    "fingerprint": "redis-session-bogus-01",
    "title": "Slice 22 — bogus sessionId fallback"
  },
  "sessionId": "deadbeef-dead-beef-dead-beefdeadbeef"
}

###########################################################################
# Y · Slice 23 — Reporting MVP (Read-Only Safe-Actions Reports)
#     Four GET endpoints under /reports/safe-actions/*.
#     All are read-only; optional x-tenant-id header for filtering.
###########################################################################

@tenantY = tenant-verify-23

### Y1 · Summary — no filters (all tenants, all time)
# @name summaryAll
GET {{baseUrl}}/reports/safe-actions/summary

### Y2 · Summary — filtered by tenant and date range
# @name summaryFiltered
GET {{baseUrl}}/reports/safe-actions/summary?fromUtc=2025-01-01&toUtc=2025-12-31
x-tenant-id: {{tenantY}}

### Y3 · Summary — invalid fromUtc → 400
# @name summaryBadDate
GET {{baseUrl}}/reports/safe-actions/summary?fromUtc=not-a-date

### Y4 · By action type — all tenants
# @name byActionTypeAll
GET {{baseUrl}}/reports/safe-actions/by-action-type

### Y5 · By action type — filtered by tenant
# @name byActionTypeTenant
GET {{baseUrl}}/reports/safe-actions/by-action-type?fromUtc=2025-01-01&toUtc=2025-12-31
x-tenant-id: {{tenantY}}

### Y6 · By tenant breakdown (leadership view)
# @name byTenant
GET {{baseUrl}}/reports/safe-actions/by-tenant

### Y7 · Recent actions — default limit (20)
# @name recentDefault
GET {{baseUrl}}/reports/safe-actions/recent

### Y8 · Recent actions — custom limit with tenant filter
# @name recentFiltered
GET {{baseUrl}}/reports/safe-actions/recent?limit=5
x-tenant-id: {{tenantY}}

### ════════════════════════════════════════════════════════════════
# Z · Slice 24 — AlertIngestion Hardening + Provider Normalization
#
# Tests the new IngestAlertRequest { Provider, Payload } contract:
#   - Z1: AzureMonitor happy path  → 200
#   - Z2: Datadog happy path       → 200
#   - Z3: Generic happy path       → 200
#   - Z4: Unsupported provider     → 400 unsupported_provider
#   - Z5: Missing x-tenant-id      → 400 missing_tenant
#   - Z6: Empty payload            → 400 invalid_alert_payload
### ════════════════════════════════════════════════════════════════

@tenantZ = tenant-verify-24

### Z1 · AzureMonitor — happy path → 200
# @name azMonitorIngest
POST {{baseUrl}}/ingest/alert
Content-Type: application/json
x-tenant-id: {{tenantZ}}

{
  "provider": "azure_monitor",
  "payload": "{\"data\":{\"essentials\":{\"alertId\":\"az-alert-z1\",\"alertRule\":\"HighCpu\",\"severity\":\"Sev1\",\"firedDateTime\":\"2025-06-01T12:00:00Z\",\"targetResourceIds\":[\"/subscriptions/abc/resourceGroups/rg/providers/Microsoft.Compute/virtualMachines/vm1\"],\"monitoringService\":\"Metric\",\"description\":\"CPU > 90%\",\"targetResourceType\":\"Microsoft.Compute/virtualMachines\",\"monitorCondition\":\"Fired\"}}}"
}

### Z2 · Datadog — happy path → 200
# @name datadogIngest
POST {{baseUrl}}/ingest/alert
Content-Type: application/json
x-tenant-id: {{tenantZ}}

{
  "provider": "datadog",
  "payload": "{\"id\":\"dd-z2\",\"title\":\"Disk Full\",\"body\":\"Disk usage above 95%\",\"priority\":\"p2\",\"date_happened\":1717243200,\"host\":\"web-01.prod\",\"alert_type\":\"Metric\",\"tags\":[\"env:production\",\"team:ops\"]}"
}

### Z3 · Generic — happy path → 200
# @name genericIngest
POST {{baseUrl}}/ingest/alert
Content-Type: application/json
x-tenant-id: {{tenantZ}}

{
  "provider": "generic",
  "payload": "{\"id\":\"gen-z3\",\"title\":\"Generic Alert\",\"severity\":\"Warning\",\"resourceId\":\"host-42\",\"sourceType\":\"Event\",\"description\":\"Something happened\"}"
}

### Z4 · Unsupported provider → 400 unsupported_provider
# @name unsupportedProvider
POST {{baseUrl}}/ingest/alert
Content-Type: application/json
x-tenant-id: {{tenantZ}}

{
  "provider": "splunk",
  "payload": "{\"id\":\"splunk-z4\",\"title\":\"Some alert\"}"
}

### Z5 · Missing x-tenant-id header → 400 missing_tenant
# @name missingTenant
POST {{baseUrl}}/ingest/alert
Content-Type: application/json

{
  "provider": "azure_monitor",
  "payload": "{\"data\":{\"essentials\":{\"alertId\":\"az-z5\",\"alertRule\":\"MemHigh\",\"severity\":\"Sev2\",\"firedDateTime\":\"2025-06-01T13:00:00Z\",\"targetResourceIds\":[\"/subscriptions/abc/vm/vm2\"],\"monitoringService\":\"Metric\",\"description\":\"Mem > 80%\",\"targetResourceType\":\"Microsoft.Compute/virtualMachines\",\"monitorCondition\":\"Fired\"}}}"
}

### Z6 · Empty payload → 400 invalid_alert_payload
# @name emptyPayload
POST {{baseUrl}}/ingest/alert
Content-Type: application/json
x-tenant-id: {{tenantZ}}

{
  "provider": "azure_monitor",
  "payload": ""
}

###########################################################################
# AA · Slice 25 — Evaluation MVP
###########################################################################

### AA1 · Run all evaluation scenarios → 200 OK
# @name evaluationRun
GET {{baseUrl}}/evaluation/run
Accept: application/json

### AA2 · List all evaluation scenario metadata → 200 OK
# @name evaluationScenarios
GET {{baseUrl}}/evaluation/scenarios
Accept: application/json

###########################################################################
# AB · Slice 26 — Connectors MVP
#
# Internal-only module — no HTTP endpoints exposed.
# Connectors are resolved via IConnectorRegistry through DI.
# See tests/Modules/Connectors for coverage.
###########################################################################

###########################################################################
# AC · Slice 27 — Platform Reporting (Evaluation + Connector Awareness)
###########################################################################

### AC1 · Evaluation summary report → 200 OK
# @name evaluationSummaryReport
GET {{baseUrl}}/reports/platform/evaluation-summary
Accept: application/json

### AC2 · Connector inventory report → 200 OK
# @name connectorInventoryReport
GET {{baseUrl}}/reports/platform/connectors
Accept: application/json

### AC3 · Platform readiness report → 200 OK
# @name platformReadinessReport
GET {{baseUrl}}/reports/platform/readiness
Accept: application/json

###########################################################################
# AD · Slice 28 — Tenancy + Governance Config Store MVP
#
# DB-backed tenant registry + per-tenant config entries with
# governance-default fallback resolution.
#   - AD1: Create tenant               → 201 Created
#   - AD2: List tenants                 → 200 OK
#   - AD3: Get tenant by ID             → 200 OK
#   - AD4: Upsert tenant setting        → 200 OK
#   - AD5: Get raw tenant settings      → 200 OK
#   - AD6: Get resolved (merged) config → 200 OK
###########################################################################

@tenantDisplayName = Contoso-Ops

### AD1 · Create tenant → 201 Created
# @name createTenant
POST {{baseUrl}}/tenants
Content-Type: application/json
x-identity: admin@contoso.com

{
  "displayName": "{{tenantDisplayName}}"
}

### AD2 · List tenants → 200 OK
# @name listTenants
GET {{baseUrl}}/tenants
Accept: application/json

### AD3 · Get tenant by ID → 200 OK
### (paste the tenantId from the AD1 response)
# @name getTenant
GET {{baseUrl}}/tenants/{{createTenant.response.body.tenantId}}
Accept: application/json

### AD4 · Upsert tenant setting → 200 OK
# @name upsertSetting
PUT {{baseUrl}}/tenants/{{createTenant.response.body.tenantId}}/settings
Content-Type: application/json
x-identity: admin@contoso.com

{
  "key": "TriageEnabled",
  "value": "true"
}

### AD5 · Get raw tenant settings → 200 OK
# @name getRawSettings
GET {{baseUrl}}/tenants/{{createTenant.response.body.tenantId}}/settings
Accept: application/json

### AD6 · Get resolved (merged) config → 200 OK
# @name getResolvedConfig
GET {{baseUrl}}/tenants/{{createTenant.response.body.tenantId}}/settings/resolved
Accept: application/json
